@page "/"
@using LitExplore.Client.Connections
@using LitExplore.Client.Papers
@using LitExplore.Client.Teams
@inject HttpClient Http
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager



<PageTitle>LitExplore</PageTitle>

<AuthorizeView>
  <Authorized>
  <div>
    @if ( _dataIsLoaded )
    {
        @foreach (PaperDTO p in Model.Graph.allPapers) 
        {
            <div class="paperbutton" @onclick="() => _selectedPaper = p">
                <PaperNode paper=@p left=@getLeftPosPaper(p) top=@getTopPosPaper(p) />
            </div>
        }
        <ConnectionLines connections=@Model.Graph.publicConnections extraConnections=@_userOrTeamConnections />
        <AddConnectionWindow />
    } 
    else 
    {
        <div class="loadingcontainer">
            <div class="loadinglabel">Loading ...</div>
        </div>
    }

    <div class="teams">
        <button type="button" @onClick="() => setSelectedTeam()" class="teambutton" data-bs-toggle="modal" data-bs-target="#teamModal" />
    </div>
    <PaperInfoWindow paper=@_selectedPaper/>
    <TeamCustomisation team=@_selectedTeam/>
    <div class="addconnbutton" type="button" data-bs-toggle="modal" data-bs-target="#AddConnectionModal">+ Add connection</div>
    
  </div>
  </Authorized>
</AuthorizeView>


@code {
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            NavigationManager.NavigateTo($"{NavigationManager.BaseUri}Login");
        } 
        else 
        {
            if (!Model.CurrentUser.initialised()) 
            {
                string userId = string.Empty;
                var claims = user.Claims;
                foreach (var claim in claims) 
                {
                    if (claim.Type.Equals("oid"))
                    {
                        userId = claim.Value;
                    }
                }

                var userDTO = new UserCreateDTO
                {
                    oid = userId,
                    Name = user.Identity?.Name
                };
                
                var response = await Http.PostAsJsonAsync("api/User", userDTO);
                Model.CurrentUser.userOid = userId;
                if (Model.CurrentUser.teams == null) Model.CurrentUser.teams = await Http.GetFromJsonAsync<TeamDTO[]>($"api/User/teams/{userId}");
                if (Model.CurrentUser.connections == null) Model.CurrentUser.connections = await Http.GetFromJsonAsync<ConnectionDTO[]>($"api/User/connections/{userId}");
            }

            _userOrTeamConnections = Model.CurrentUser.connections;

            if (!Model.Graph.initialised()) 
            {
                Model.Graph.allPapers = await Http.GetFromJsonAsync<PaperDTO[]>("api/Paper");
                Model.Graph.publicConnections = await Http.GetFromJsonAsync<ConnectionDTO[]>("api/Connection");
                Model.Graph.initialise();
            }
            _selectedPaper = Model.Graph.allPapers.ElementAt(0);
            _dataIsLoaded = true;
        }
    }

    private bool _dataIsLoaded = false;

    
    private ConnectionLines? _connectionLines;
    private int getLeftPosPaper(PaperDTO p) => Model.Graph.paperToPositions[p.Id].Item1;
    private int getTopPosPaper(PaperDTO p) => Model.Graph.paperToPositions[p.Id].Item2;

    private ConnectionDTO[]? _userOrTeamConnections;
    private PaperDTO _selectedPaper = TestEntities.paperDTO;
    private TeamDTO _selectedTeam = TestEntities.teamDTO;
    private void setSelectedTeam(TeamDTO team) 
    {
        _selectedTeam = team;
    }
}