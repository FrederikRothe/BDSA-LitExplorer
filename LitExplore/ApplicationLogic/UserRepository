namespace LitExplore.ApplicationLogic;

public class UserRepository : IUserRepository
{

    private readonly ILitExploreContext _context;

    public UserRepository(ILitExploreContext context)
    {
        _context = context;
    }
    public async Task<UserDTO> CreateAsync(UserCreateDTO user)
    {
        if (user == null) return null;
        var entity = new User
        {
            Id = user.Id,
            Name = user.Name
            Connections = new List<Connection>();
            Teams = new List<Teams>();
        };

        _context.Teams.Add(entity);

        await _context.SaveChangesAsync();

        return new UserDTO(
                            entity.Id,
                            entity.Name,
                            entity.Connections.Select(c => c.Id),
                            entity.Teams.Select(t => t.Id)
                        );
    }

    private User FindUser(int userId) => _context.Users.Where(u => u.Id == userId).First();

    public async Task<Status> DeleteAsync(int userId)
    {
        var entity = FindUser(userId);

        if (entity == null)
        {
            return NotFound;
        }

        _context.Users.Remove(entity);
        await _context.SaveChangesAsync();

        return Deleted;
    }

    public async Task<Option<UserDTO>> ReadAsync(int userId)
    {
        var users = from u in _context.Users
                    where u.Id == userId
                    select new UserDTO(
                        u.Id,
                        u.Name,
                        u.Connections.Select(c => c.Id),
                        u.Teams.Select(t => t.Id)
                    );

        return await teams.FirstOrDefaultAsync();
    }

    public async Task<Status> UpdateAsync(int id, UserUpdateDTO user)
    {
        var entity = FindUser(userId);

        if (entity == null)
        {
            return NotFound;
        }

        entity.Connections = _context.Connections.Where(c => user.ConnectionIDs.Contains(c.Id));
        entity.Teams = _context.Teams.Where(t => user.TeamIds.Contains(t.Id));

        await _context.SaveChangesAsync();

        return Updated;
    }
}
